<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Toggle Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .video-container {
            width: 400px;
            height: 300px;
            background: #000;
            border-radius: 8px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a6fd8;
        }
        .status {
            background: #2a2a4a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .log {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Camera Toggle Test</h1>
    
    <div class="video-container">
        <video id="video" autoplay playsinline muted></video>
        <div id="status" class="status">Camera: Off</div>
    </div>
    
    <div class="controls">
        <button id="toggleBtn">Turn Camera On</button>
        <button id="clearLog">Clear Log</button>
    </div>
    
    <div class="log" id="log"></div>

    <script>
        let localStream = null;
        let isVideoOff = true;
        const video = document.getElementById('video');
        const toggleBtn = document.getElementById('toggleBtn');
        const status = document.getElementById('status');
        const log = document.getElementById('log');
        
        function logMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateStatus() {
            status.textContent = `Camera: ${isVideoOff ? 'Off' : 'On'}`;
            toggleBtn.textContent = isVideoOff ? 'Turn Camera On' : 'Turn Camera Off';
        }
        
        async function toggleVideo() {
            logMessage(`toggleVideo called, isVideoOff: ${isVideoOff}`);
            
            if (isVideoOff) {
                // Turning camera ON
                logMessage('Turning camera ON...');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1920, min: 1280 },
                            height: { ideal: 1080, min: 720 },
                            frameRate: { ideal: 30, min: 15 },
                            facingMode: 'user'
                        },
                        audio: false,
                    });
                    
                    logMessage('Got new video stream: ' + stream.id);
                    logMessage('New video tracks: ' + stream.getVideoTracks().length);
                    
                    // Stop old video tracks
                    if (localStream) {
                        const oldVideoTracks = localStream.getVideoTracks();
                        logMessage('Stopping old video tracks: ' + oldVideoTracks.length);
                        oldVideoTracks.forEach(track => track.stop());
                    }
                    
                    // Create a completely new stream with both audio and video
                    logMessage('Creating new combined stream...');
                    const audioStream = await navigator.mediaDevices.getUserMedia({
                        video: false,
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    const combinedStream = new MediaStream([
                        ...audioStream.getAudioTracks(),
                        ...stream.getVideoTracks()
                    ]);
                    
                    logMessage('Created combined stream: ' + combinedStream.id);
                    localStream = combinedStream;
                    
                    video.srcObject = localStream;
                    isVideoOff = false;
                    logMessage('Camera turned ON successfully');
                } catch (error) {
                    logMessage('Error turning on camera: ' + error.message);
                }
            } else {
                // Turning camera OFF - completely destroy video stream
                logMessage('Turning camera OFF...');
                if (localStream) {
                    const videoTracks = localStream.getVideoTracks();
                    logMessage('Stopping video tracks: ' + videoTracks.length);
                    
                    // Stop all video tracks immediately
                    videoTracks.forEach(track => {
                        track.stop();
                    });
                    
                    // Get audio tracks before destroying the stream
                    const audioTracks = localStream.getAudioTracks();
                    
                    // Completely destroy the current stream
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                    video.srcObject = null;
                    
                    // Create a completely new audio-only stream
                    if (audioTracks.length > 0) {
                        const audioOnlyStream = new MediaStream(audioTracks);
                        logMessage('Created audio-only stream: ' + audioOnlyStream.id);
                        localStream = audioOnlyStream;
                        video.srcObject = localStream;
                    }
                    
                    // Force garbage collection to release camera resources
                    setTimeout(() => {
                        if (window.gc) {
                            window.gc();
                        }
                    }, 200);
                }
                isVideoOff = true;
                logMessage('Camera turned OFF successfully');
            }
            
            updateStatus();
        }
        
        toggleBtn.addEventListener('click', toggleVideo);
        document.getElementById('clearLog').addEventListener('click', () => {
            log.innerHTML = '';
        });
        
        updateStatus();
        logMessage('Test page loaded');
    </script>
</body>
</html>
